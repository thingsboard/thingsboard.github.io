* TOC
{:toc}

X.509 Certificate Chain Authentication is a widely used method for securing MQTT connections in enterprise environments and IoT deployments requiring strong identity verification.
Instead of relying on a username and password, clients present a certificate during the TLS handshake, allowing the broker to authenticate them based on the Common Name (CN) certificate attribute.

### X.509 authentication overview

With X.509 Certificate Chain Authentication, the client presents its certificate chain as part of the TLS handshake.
TBMQ extracts the Common Name (CN) from the client’s certificate, or any certificate in the chain to generate `credentialsId` and match it against the configured [MQTT client credentials](/docs/{{docsPrefix}}mqtt-broker/user-guide/ui/mqtt-client-credentials/).

TBMQ supports two matching modes:

- **Exact match** — where the CN in the certificate must exactly match the configured pattern.
- **Regular expression (regex) match** — where the CN must match a regex pattern, allowing flexible matching for groups of certificates.

After a successful match, the client is authenticated. For performance and low-latency lookups, TBMQ caches credentials in Redis, while PostgreSQL ensures persistent storage.
The following sections explain provider configuration, credential matching, `credentialsId` generation, and how authorization is applied after successful authentication.

### Configure provider

{% include docs/mqtt-broker/user-guide/ui/authentication-provider-control.md %}

#### Skip certificate validity check for client certificates

The **Skip certificate validity check for client certificates** parameter in X.509 Certificate Chain Authentication controls whether the broker verifies the validity period of the client's certificate during authentication.
* When `enabled`, TBMQ skips the validation of the Not Before and Not After dates in the certificate, meaning expired or not-yet-valid certificates will still be accepted.
* When `disabled`, the broker enforces the standard validity checks, and authentication will fail if the certificate is expired or not yet valid.

This setting can be useful in testing or specific trust-controlled environments, but set it to `true` is not recommended for production deployments, as it weakens the certificate-based security model.

### Credentials matching

The "X.509 Certificate Chain" credentials have a **"Use certificate CN regex"** option that controls how credentials are matched.

* When "Use certificate CN regex" is disabled:
the "Certificate common name (CN)" must **exactly** match the CN of the client's certificate or, if present, one of the parent's certificates in the chain. 
Authentication will fail if none of the certificates have an exactly matching CN.

* "Use certificate CN regex" is enabled:
the "Certificate common name (CN) matcher regex" must match the CN of the client's certificate or, if present, one of the parent's certificates in the chain. 
Authentication will fail if no certificate in the chain matches the regex.

### Credentials ID

The generation of `credentialsId` is done as follows:

- credentialsId = `ssl|$CERTIFICATE_COMMON_NAME`;
- credentialsId = `ssl|$CERTIFICATE_COMMON_NAME_REGEX`.

Where `$CERTIFICATE_COMMON_NAME` is the common name of the certificate from the chain, `$CERTIFICATE_COMMON_NAME_REGEX` is a regex-based string
that should be matched with the certificate's CN from the chain.

{% include images-gallery.html imageCollection="security-authentication-tls" %}

### Authorization

After the user has been authenticated, it is possible to restrict the client's access to topics they can publish or subscribe to.

To provide flexible control over authorization rules, TBMQ uses regular expressions. 

For example, to **allow clients to publish or subscribe to all topics** that begin with **city/**, an authorization rule should be created with the value **city/.***.

For TLS type, authorization is configured using the **authRulesMapping** field of the corresponding MQTT Client Credentials.
Here is a model of the credentials value:

```
{
    "certCnPattern": $certCnPattern,
    "certCnIsRegex": $certCnIsRegex,
    "authRulesMapping": $authRulesMapping
}
```
{: .copy-code}

Where:
- $certCnPattern - the pattern for the common name that should be present in the certificate chain.
- $certCnIsRegex - option to control whether the common name (CN) pattern is treated as a regular expression (regex) for matching.
- $authRulesMapping - the mapping used to configure the access restrictions for different keywords.
  For example,
  ```
  {
      "example_1": {
	      "pubAuthRulePatterns": ["example_pub_topic/.*"],
	      "subAuthRulePatterns": ["example_sub_topic/.*"]
	  },
	  "example_2": {
          "pubAuthRulePatterns": [".*"],
		  "subAuthRulePatterns": [".*"]
      }
  }
  ```
  {: .copy-code}

This allows clients to connect with a certificate containing **example_1** in its CN to publish only to topics that start with **example_pub_topic/** and 
subscribe to topics that start with **example_sub_topic/**. Clients with a certificate containing **example_2** are allowed to publish and subscribe to any topic.

**Note:** if either **pubAuthRulePatterns** or **subAuthRulePatterns** is set to `null` or an empty list (`[]`), the client will not be able to publish to or subscribe to any topics.

{% include images-gallery.html imageCollection="security-authorization-tls" %}

### Example

X.509 Certificates are used to set up [mutual](https://en.wikipedia.org/wiki/Mutual_authentication) (two-way) authentication for MQTT over TLS.
The instructions below will describe how to connect MQTT client using X.509 Certificate to TBMQ.

In particular, there are two strategies that can be used for establishing connection between the client and TBMQ:

- **X.509 Certificate chain**. <br>
  Configure TBMQ to trust all client certificates from a specific trust anchor (*intermediate certificate*).
  This feature eliminates the need for manual certificate updates on each MQTT client credential when certificate rotation occurs.
- **X.509 Certificate.** <br> Configure TBMQ to accept connections from the specific devices using pre-configured client certificates.

{% capture contenttogglespecx509 %}
X.509 Certificate chain%,%x509Chain%,%templates/mqtt-broker/ssl/tbmq-certificates-chain.md%br%
X.509 Certificate%,%X509Leaf%,%templates/mqtt-broker/ssl/tbmq-certificates-leaf.md%br%{% endcapture %}

{% include content-toggle.liquid content-toggle-id="tbmqX509" toggle-spec=contenttogglespecx509 %}

## Next steps

{% assign currentGuide = "SecurityGuide" %}{% include templates/mqtt-broker-guides-banner.md %}
