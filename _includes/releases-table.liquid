{%- if docsPrefix == "edge/" -%}
    {%- assign prefix = "docs/" | append: docsPrefix | append: "releases/releases-table/" -%}
{% elsif docsPrefix == "pe/edge/" %}
    {%- assign prefix = "docs/" | append: docsPrefix | append: "releases/releases-table/" -%}
{%- else -%}
    {%- assign prefix = "docs/" | append: docsPrefix | append: "releases/releases-table/" -%}
{%- endif -%}


{%- assign releases = site.pages | where_exp: "p", "p.path contains prefix" -%}
{%- assign releases = releases | sort: "path" | reverse -%}

<div class="releases-table{% if docsPrefix == "pe/" %} pe-table{% elsif docsPrefix == "edge/" %} edge-table{% elsif docsPrefix == "pe/edge/" %} pe-edge-table{% endif %}">
    <div class="releases-table-content">
        <div class="releases-table-header">
            <div class="releases-table-header-item">Version</div>
            <div class="releases-table-header-item">First Released</div>
            <div class="releases-table-header-item cur-patch">Current Patch</div>
            <div class="releases-table-header-item">Support</div>
            <div class="releases-table-header-item">End of Life</div>
            <div class="releases-table-header-item">Release Notes & Highlights</div>
            <div class="releases-table-header-item">Instructions</div>
        </div>

        <div class="releases-table-row">
            {% for page in releases %}
                {% if page.name != "index.md" %}
                    {% assign version = page.name | split: "." | first %}
                    <div class="releases-table-content-wrapper"
                         onclick="window.open('{{ page.url }}', '_blank')"
                         style="cursor:pointer;">
                        <div class="releases-table-content">

                            {%- assign month_map =  "January:Jan,February:Feb,March:Mar,April:Apr,May:May,June:Jun,July:Jul,August:Aug,September:Sep,October:Oct,November:Nov,December:Dec" | split: "," -%}

                            {%- assign release_month_full = page.release-date | date: "%B" -%}

                            {%- for pair in month_map -%}
                                {%- assign parts = pair | split: ":" -%}
                                {%- if parts[0] == release_month_full -%}
                                    {%- assign release_month_short = parts[1] -%}
                                {%- endif -%}
                            {%- endfor -%}

                            <div class="releases-table-content-item">
                                {{ version | replace: "-", "." | replace: ".x", "" }}{% if docsPrefix == "pe/" %}PE
                                {%- elsif docsPrefix == "edge/" or docsPrefix == "pe/edge/" -%}Edge
                                {%- endif -%}
                            </div>

                            <div class="releases-table-content-item">
                                <time datetime="{{ page.release-date | date: '%Y-%m-%d' }}">
                                    {{ page.release-date | date: "%-d" }} {{ release_month_short }} {{ page.release-date | date: "%Y" }}
                                </time>
                            </div>

                            <div class="releases-table-content-item cur-patch">
                                {{ page.latest-patch }}
                            </div>


                            {% if page.lts %}
                                <a href="/docs/{{ docsPrefix }}releases/release-policy/"
                                   class="releases-table-content-item version-link version-link-lts"
                                   target="_blank">
                                <span style="font-weight: 500; color: {% if docsPrefix == "pe/" %}#1F8B4D{% elsif docsPrefix == "edge/" %}#2260A7{% elsif docsPrefix == "pe/edge/" %}#009688{% else %}#2a7dec{% endif %}">
                                    Active LTS
                                </span>
                                    <i class="fas fa-external-link-alt"
                                       style="color: {% if docsPrefix == "pe/" %}#1F8B4D{% elsif docsPrefix == "edge/" %}#2260A7{% elsif docsPrefix == "pe/edge/" %}#009688{% else %}#2a7dec{% endif %}"></i>
                                </a>
                            {% else %}
                                <div class="releases-table-content-item">Standard</div>
                            {% endif %}

                            {% assign release_ts = page.release-date | date: "%s" %}

                            {% if page.lts %}
                                {% assign target_ts = release_ts | plus: 46656000 %}
                            {% else %}
                                {% assign target_ts = release_ts | plus: 15552000 %}
                            {% endif %}

                            {% assign now_ts = "now" | date: "%s" | plus: 0 %}

                            {%- assign target_month_full = target_ts | date: "%B" -%}

                            {%- for pair in month_map -%}
                                {%- assign parts = pair | split: ":" -%}
                                {%- if parts[0] == target_month_full -%}
                                    {%- assign target_month_short = parts[1] -%}
                                {%- endif -%}
                            {%- endfor -%}

                            <div class="releases-table-content-item{% if target_ts < now_ts %} old-date{% endif %}">
                                {% if page.lts %}
                                    {{ target_month_short }} {{ target_ts | date: "%Y" }}
                                {% else %}
                                    {{ target_ts | date: "%-d" }} {{ target_month_short }} {{ target_ts | date: "%Y" }}
                                {% endif %}
                            </div>

                            <a href="{{ page.url }}" class="releases-table-content-item version-link" target="_blank">
                                <span>{{ page.release-note-label }}</span>
                                <i class="fas fa-external-link-alt" style="opacity: 0.54; color: #000"></i>
                            </a>

                            <div class="releases-table-content-item upgrade-link">
                            {% if docsPrefix == "edge/" or docsPrefix == "pe/edge/" %}
                                <a href="/docs/user-guide/install/{{ docsPrefix }}upgrade-instructions/?version={{ version }}" target="_blank">
                                    Upgrade
                                </a>
                            {% else %}
                                <a href="/docs/{{ docsPrefix }}user-guide/install/upgrade-instructions/?version={{ version }}" target="_blank">
                                    Upgrade
                                </a>
                            {% endif %}
                            </div>

                        </div>
                    </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
<ul class="legend{% if docsPrefix == "pe/" %} pe{% elsif docsPrefix == "edge/" or docsPrefix == "pe/edge/" %} edge{% endif %}">
    <li class="list-link"><a href="/docs/{{ docsPrefix }}releases/release-policy/" target="_blank">Active LTS</a> - releases are supported for 18 months from the initial release date.</li>
    <li>Standard - releases are supported for six months from the initial release date.</li>
</ul>
<div class="fixed-upgrade-scrollbar" id="fixedScrollbar">
    <div class="scrollbar-inner"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const table = document.querySelector('.releases-table');
        if (!table) return;

        const content = table.querySelector('.releases-table-content');
        const bar = document.getElementById('fixedScrollbar');
        if (!content || !bar) return;

        const inner = bar.querySelector('.scrollbar-inner');

        function updateScrollBar() {
            const rect = table.getBoundingClientRect();
            const viewportHeight = window.innerHeight;

            const scrollWidth = content.scrollWidth;
            const visibleWidth = table.clientWidth;

            if (scrollWidth <= visibleWidth + 1) {
                bar.style.display = 'none';
                return;
            }


            const distanceBelowViewport = rect.bottom - viewportHeight;

            const completelyAboveViewport = rect.bottom <= 0;
            const completelyBelowViewport = rect.top >= viewportHeight;

            if (completelyAboveViewport || completelyBelowViewport || distanceBelowViewport <= 30) {
                bar.style.display = 'none';
                return;
            }

            bar.style.display = 'block';

            bar.style.width = rect.width + 'px';
            bar.style.left = rect.left + 'px';

            inner.style.width = scrollWidth + 'px';
        }

        updateScrollBar();

        if ('ResizeObserver' in window) {
            new ResizeObserver(updateScrollBar).observe(content);
            new ResizeObserver(updateScrollBar).observe(table);
        } else {
            window.addEventListener('resize', updateScrollBar);
        }

        window.addEventListener('scroll', updateScrollBar);
        window.addEventListener('resize', updateScrollBar);

        let syncFromTable = false;
        let syncFromBar = false;

        table.addEventListener('scroll', () => {
            if (syncFromBar) {
                syncFromBar = false;
                return;
            }
            syncFromTable = true;
            bar.scrollLeft = table.scrollLeft;
        });

        bar.addEventListener('scroll', () => {
            if (syncFromTable) {
                syncFromTable = false;
                return;
            }
            syncFromBar = true;
            table.scrollLeft = bar.scrollLeft;
        });

        const rowLinks = document.querySelectorAll('.releases-table-content-wrapper a');
        rowLinks.forEach(link => {
            link.addEventListener('click', function (event) {
                event.stopPropagation();
            });
        });
    });
</script>
