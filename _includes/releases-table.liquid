{%- assign dir = "/docs/" | append: docsPrefix | append: "releases/releases-table/" -%}

{%- assign pages_in_dir = "" | split: "" -%}
{%- for p in site.pages -%}
    {%- if p.url != dir and p.url contains dir -%}
        {%- assign slug = p.url | remove_first: dir | split: "/" | first -%}
        {%- if slug and slug != "" -%}
            {%- assign pages_in_dir = pages_in_dir | push: p -%}
        {%- endif -%}
    {%- endif -%}
{%- endfor -%}

{%- assign families = "" | split: "" -%}
{%- for p in pages_in_dir -%}
    {%- assign slug = p.url | remove_first: dir | split: "/" | first -%}
    {%- assign normalized_slug = slug | remove: "v" | replace: "-", "." -%}
    {%- assign parts = normalized_slug | split: "." -%}
    {%- assign major = parts[0] -%}
    {%- assign minor = parts[1] -%}
    {%- if major and minor -%}
        {%- assign fam = "v" | append: major | append: "." | append: minor -%}
        {%- unless families contains fam -%}
            {%- assign families = families | push: fam -%}
        {%- endunless -%}
    {%- endif -%}
{%- endfor -%}

{%- assign sortable = "" | split: "" -%}
{%- for f in families -%}
    {%- assign n = f | remove: "v" | split: "." -%}
    {%- assign major = n[0] | plus: 0 -%}
    {%- assign minor = n[1] | plus: 0 -%}
    {%- capture key %}{{ "%03d" | format: major }}.{{ "%03d" | format: minor }}|{{ f }}{% endcapture -%}
    {%- assign sortable = sortable | push: key -%}
{%- endfor -%}

{%- assign sortable = sortable | sort_natural | reverse -%}

<div class="releases-table{% if docsPrefix == "pe/" %} pe-table{% endif %}">
    <div class="releases-table-content">
        <div class="releases-table-header">
            <div class="releases-table-header-item">Version</div>
            <div class="releases-table-header-item">Release Date</div>
            <div class="releases-table-header-item">Latest Tag</div>
            <div class="releases-table-header-item">Last Updated</div>
            <div class="releases-table-header-item">Status</div>
            <div class="releases-table-header-item">Release Notes</div>
            <div class="releases-table-header-item">Upgrade Instructions</div>
        </div>

        <div class="releases-table-row">
            {%- for entry in sortable -%}
                {%- assign family = entry | split: "|" | last -%}

                {%- assign x_slug = family | replace: ".", "-" | append: "-x" -%}
                {%- assign x_url = dir | append: x_slug | append: "/" -%}
                {%- assign has_x = false -%}
                {%- for q in site.pages -%}
                    {%- if q.url == x_url -%}
                        {%- assign has_x = true -%}
                        {%- break -%}
                    {%- endif -%}
                {%- endfor -%}

                {%- assign earliest_ts = "" -%}
                {%- assign earliest_date = "" -%}
                {%- assign latest_ts = "" -%}
                {%- assign latest_version = "" -%}
                {%- assign latest_date = "" -%}

                {%- for q in pages_in_dir -%}
                    {%- assign qslug = q.url | remove_first: dir | split: "/" | first -%}
                    {%- assign qnormalized = qslug | remove: "v" | replace: "-", "." -%}
                    {%- assign qparts = qnormalized | split: "." -%}
                    {%- assign qmajor = qparts[0] -%}
                    {%- assign qminor = qparts[1] -%}
                    {%- assign qfamily = "v" | append: qmajor | append: "." | append: qminor -%}
                    {%- if qfamily != family -%}{%- continue -%}{%- endif -%}
                    {%- assign suffix = qslug | slice: -2, 2 -%}
                    {%- if suffix == "-x" -%}{%- continue -%}{%- endif -%}

                    {%- assign qdate = q["release-date"] -%}
                    {%- assign qts = qdate | date: "%s" -%}

                    {%- if earliest_ts == "" or qts < earliest_ts -%}
                        {%- assign earliest_ts = qts -%}
                        {%- assign earliest_date = qdate -%}
                    {%- endif -%}
                    {%- if latest_ts == "" or qts > latest_ts -%}
                        {%- assign latest_ts = qts -%}
                        {%- assign latest_version = qslug | replace: "-", "." -%}
                        {%- assign latest_date = qdate -%}
                    {%- endif -%}
                {%- endfor -%}

                {%- if has_x -%}
                    {%- assign notes_url = x_url -%}
                {%- else -%}
                    {%- assign notes_url = dir | append: latest_version | append: "/" -%}
                {%- endif -%}

                {%- assign lts_label = "non-LTS" -%}
                {%- if has_x -%}
                    {%- for p in site.pages -%}
                        {%- if p.url == x_url -%}
                            {%- if p.lts -%}
                                {%- assign lts_label = p.lts -%}
                            {%- endif -%}
                            {%- break -%}
                        {%- endif -%}
                    {%- endfor -%}
                {%- else -%}
                    {%- assign latest_url = dir | append: latest_version | append: "/" -%}
                    {%- for p in site.pages -%}
                        {%- if p.url == latest_url -%}
                            {%- if p.lts -%}
                                {%- assign lts_label = p.lts -%}
                            {%- endif -%}
                            {%- break -%}
                        {%- endif -%}
                    {%- endfor -%}
                {%- endif -%}

                <div
                        class="releases-table-content-wrapper"
                        onclick="window.location='{{ notes_url | replace: ".", "-" }}'"
                        style="cursor:pointer;">
                    <div class="releases-table-content">
                        <div class="releases-table-content-item">{{ family }}.x{% if docsPrefix == "pe/" %}PE{% endif %}</div>
                        <div class="releases-table-content-item">
                            {%- if earliest_date -%}
                                <time datetime="{{ earliest_date | date: '%Y-%m-%d' }}">{{ earliest_date | date: "%B %-d, %Y" }}</time>
                            {%- else -%}—{%- endif -%}
                        </div>
                        <div class="releases-table-content-item">{{ latest_version | default: "—" }}{% if docsPrefix == "pe/" %}PE{% endif %}</div>
                        <div class="releases-table-content-item">
                            {%- if latest_date -%}
                                <time datetime="{{ latest_date | date: '%Y-%m-%d' }}">
                                    {{ latest_date | date: "%B %-d, %Y" }}
                                </time>
                            {%- else -%}—{%- endif -%}
                        </div>
                        {% if lts_label != "non-LTS" %}
                            <a href="/docs/releases/release-policy/" class="releases-table-content-item version-link">
                                <span style="font-weight: 500; color: {% if docsPrefix == "pe/" %}#00695C{% else %}#2a7dec{% endif %}">LTS ({{ lts_label }})</span>
                                <i class="fas fa-external-link-alt" style="color: {% if docsPrefix == "pe/" %}#00695C{% else %}#2a7dec{% endif %}"></i>
                            </a>
                        {% else %}
                            <div class="releases-table-content-item">{{ lts_label }}</div>
                        {% endif %}
                        <a href="{{ notes_url | replace: ".", "-" }}" class="releases-table-content-item version-link">
                            <span>{{ family }}</span>
                            <i class="fas fa-external-link-alt" style="opacity: 0.54; color: #000"></i>
                        </a>
                        <a class="releases-table-content-item upgrade-link" href="/docs/user-guide/install/{{ docsPrefix }}upgrade-instructions/?version={{ family | replace: ".", "-" }}-x">
                            Upgrade
                        </a>
                    </div>
                </div>
            {%- endfor -%}
        </div>
    </div>
</div>
