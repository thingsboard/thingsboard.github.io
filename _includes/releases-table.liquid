{%- assign prefix = "docs/" | append: docsPrefix | append: "releases/releases-table/" -%}

{%- assign releases = site.pages | where_exp: "p", "p.path contains prefix" -%}
{%- assign releases = releases | sort: "path" | reverse -%}

<div class="releases-table{% if docsPrefix == "pe/" %} pe-table{% endif %}">
    <div class="releases-table-content">
        <div class="releases-table-header">
            <div class="releases-table-header-item">Version</div>
            <div class="releases-table-header-item">Release Date</div>
            <div class="releases-table-header-item">Latest Tag</div>
            <div class="releases-table-header-item">Last Updated</div>
            <div class="releases-table-header-item">Status</div>
            <div class="releases-table-header-item">Release Notes</div>
            <div class="releases-table-header-item">Upgrade Instructions</div>
        </div>

        <div class="releases-table-row">
            {% for page in releases %}
                {% if page.name != "index.md" %}
                    {% assign version = page.name | split: "." | first %}
                    <div class="releases-table-content-wrapper"
                         onclick="window.location='{{ page.url }}'"
                         style="cursor:pointer;">
                        <div class="releases-table-content">
                            <div class="releases-table-content-item">
                                {{ version | replace: "-", "." }}{% if docsPrefix == "pe/" %}PE{% endif %}
                            </div>

                            <div class="releases-table-content-item">
                                <time datetime="{{ page.release-date | date: '%Y-%m-%d' }}">
                                    {{ page.release-date | date: "%B %-d, %Y" }}
                                </time>
                            </div>

                            <div class="releases-table-content-item">
                                {{ page.latest-tag }}{% if docsPrefix == "pe/" %}PE{% endif %}
                            </div>

                            <div class="releases-table-content-item">
                                <time datetime="{{ page.last-updated | date: '%Y-%m-%d' }}">
                                    {{ page.last-updated | date: "%B %-d, %Y" }}
                                </time>
                            </div>

                            {% if page.lts %}
                                <a href="/docs/{{ docsPrefix }}releases/release-policy/" class="releases-table-content-item version-link version-link-lts">
                                <span style="font-weight: 500; color: {% if docsPrefix == "pe/" %}#1F8B4D{% else %}#2a7dec{% endif %}">
                                    LTS ({{ page.lts }})
                                </span>
                                    <i class="fas fa-external-link-alt"
                                       style="color: {% if docsPrefix == "pe/" %}#1F8B4D{% else %}#2a7dec{% endif %}"></i>
                                </a>
                            {% else %}
                                <div class="releases-table-content-item">non-LTS</div>
                            {% endif %}

                            <a href="{{ page.url }}" class="releases-table-content-item version-link">
                                <span>{{ version | replace: "-", "." }}</span>
                                <i class="fas fa-external-link-alt" style="opacity: 0.54; color: #000"></i>
                            </a>

                            <div class="releases-table-content-item upgrade-link">
                                <a href="/docs/{{ docsPrefix }}user-guide/install/upgrade-instructions/?version={{ version }}">
                                    Upgrade
                                </a>
                            </div>

                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
<div class="fixed-upgrade-scrollbar" id="fixedScrollbar">
    <div class="scrollbar-inner"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const table = document.querySelector('.releases-table');
        if (!table) return;

        const content = table.querySelector('.releases-table-content');
        const bar = document.getElementById('fixedScrollbar');
        if (!content || !bar) return;

        const inner = bar.querySelector('.scrollbar-inner');

        function updateScrollBar() {
            const rect = table.getBoundingClientRect();
            const viewportHeight = window.innerHeight;

            const scrollWidth = content.scrollWidth;
            const visibleWidth = table.clientWidth;

            if (scrollWidth <= visibleWidth + 1) {
                bar.style.display = 'none';
                return;
            }


            const distanceBelowViewport = rect.bottom - viewportHeight;

            const completelyAboveViewport = rect.bottom <= 0;
            const completelyBelowViewport = rect.top >= viewportHeight;

            if (completelyAboveViewport || completelyBelowViewport || distanceBelowViewport <= 30) {
                bar.style.display = 'none';
                return;
            }

            bar.style.display = 'block';

            bar.style.width = rect.width + 'px';
            bar.style.left = rect.left + 'px';

            inner.style.width = scrollWidth + 'px';
        }

        updateScrollBar();

        if ('ResizeObserver' in window) {
            new ResizeObserver(updateScrollBar).observe(content);
            new ResizeObserver(updateScrollBar).observe(table);
        } else {
            window.addEventListener('resize', updateScrollBar);
        }

        window.addEventListener('scroll', updateScrollBar);
        window.addEventListener('resize', updateScrollBar);

        let syncFromTable = false;
        let syncFromBar = false;

        table.addEventListener('scroll', () => {
            if (syncFromBar) {
                syncFromBar = false;
                return;
            }
            syncFromTable = true;
            bar.scrollLeft = table.scrollLeft;
        });

        bar.addEventListener('scroll', () => {
            if (syncFromTable) {
                syncFromTable = false;
                return;
            }
            syncFromBar = true;
            table.scrollLeft = bar.scrollLeft;
        });
    });
</script>
