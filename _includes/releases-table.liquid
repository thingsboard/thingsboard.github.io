{%- assign base = page.url -%}
{%- if base == nil or base == "" -%}{%- assign base = "/docs/pe/releases/releases-table/" -%}{%- endif -%}

{%- assign release_pages = "" | split: "" -%}
{%- for p in site.pages -%}
    {%- if p.url != base and p.url contains base -%}
        {%- assign slug = p.url | remove_first: base | split: "/" | first -%}
        {%- if slug and slug != "" -%}
            {%- assign release_pages = release_pages | push: p -%}
        {%- endif -%}
    {%- endif -%}
{%- endfor -%}

{%- assign families = "" | split: "" -%}
{%- for p in release_pages -%}
    {%- assign slug = p.url | remove_first: base | split: "/" | first -%}
    {%- assign parts = slug | remove: "v" | split: "." -%}
    {%- assign major = parts[0] -%}
    {%- assign minor = parts[1] -%}
    {%- if major and minor -%}
        {%- assign fam = "v" | append: major | append: "." | append: minor -%}
        {%- unless families contains fam -%}
            {%- assign families = families | push: fam -%}
        {%- endunless -%}
    {%- endif -%}
{%- endfor -%}

{%- assign sortable = "" | split: "" -%}
{%- for f in families -%}
    {%- assign n = f | remove: "v" | split: "." -%}
    {%- assign major = n[0] | plus: 0 -%}
    {%- assign minor = n[1] | plus: 0 -%}
    {%- capture key %}{{ "%03d" | format: major }}.{{ "%03d" | format: minor }}|{{ f }}{% endcapture -%}
    {%- assign sortable = sortable | push: key -%}
{%- endfor -%}

{%- assign sortable = sortable | sort_natural | reverse -%}

<div class="releases-table">
    <div class="releases-table-content">
        <div class="releases-table-header">
            <div class="releases-table-header-item">Version</div>
            <div class="releases-table-header-item">Release Date</div>
            <div class="releases-table-header-item">Latest Tag</div>
            <div class="releases-table-header-item">Last Updated</div>
            <div class="releases-table-header-item">Support Until</div>
            <div class="releases-table-header-item">Status</div>
            <div class="releases-table-header-item">Release Notes</div>
            <div class="releases-table-header-item">Upgrade Instructions</div>
        </div>

        <div class="releases-table-row">
            {%- for entry in sortable -%}
                {%- assign family_key = entry | split: "|" | last -%}

                {%- assign x_url = base | append: family_key | append: ".x/" -%}
                {%- assign has_x = false -%}
                {%- for q in site.pages -%}
                    {%- if q.url == x_url -%}{%- assign has_x = true -%}{%- break -%}{%- endif -%}
                {%- endfor -%}

                {%- assign earliest_ts = "" -%}
                {%- assign earliest_date_display = "" -%}
                {%- assign latest_ts = "" -%}
                {%- assign latest_version_slug = "" -%}
                {%- assign latest_date_display = "" -%}

                {%- for q in release_pages -%}
                    {%- assign qslug = q.url | remove_first: base | split: "/" | first -%}
                    {%- assign qparts = qslug | remove: "v" | split: "." -%}
                    {%- assign qmajor = qparts[0] -%}
                    {%- assign qminor = qparts[1] -%}
                    {%- assign qfamily = "v" | append: qmajor | append: "." | append: qminor -%}
                    {%- if qfamily != family_key -%}{%- continue -%}{%- endif -%}
                    {%- assign suffix = qslug | slice: -2, 2 -%}
                    {%- if suffix == ".x" -%}{%- continue -%}{%- endif -%}

                    {%- assign qdate = q["release-date"] -%}
                    {%- assign qts = qdate | date: "%s" -%}

                    {%- if earliest_ts == "" or qts < earliest_ts -%}
                        {%- assign earliest_ts = qts -%}
                        {%- assign earliest_date_display = qdate -%}
                    {%- endif -%}
                    {%- if latest_ts == "" or qts > latest_ts -%}
                        {%- assign latest_ts = qts -%}
                        {%- assign latest_version_slug = qslug -%}
                        {%- assign latest_date_display = qdate -%}
                    {%- endif -%}
                {%- endfor -%}

                {%- assign family_label = family_key | append: ".x" -%}

                {%- if has_x -%}
                    {%- assign notes_url = x_url -%}
                {%- else -%}
                    {%- assign notes_url = base | append: latest_version_slug | append: "/" -%}
                {%- endif -%}

                <div class="releases-table-content-wrapper">
                    <div class="releases-table-content">
                        <div class="releases-table-content-item">{{ family_label }}</div>
                        <div class="releases-table-content-item">
                            {%- if earliest_date_display -%}
                                <time datetime="{{ earliest_date_display | date: '%Y-%m-%d' }}">{{ earliest_date_display }}</time>
                            {%- else -%}—{%- endif -%}
                        </div>
                        <div class="releases-table-content-item">{{ latest_version_slug | default: "—" }}</div>
                        <div class="releases-table-content-item">
                            {%- if latest_date_display -%}
                                <time datetime="{{ latest_date_display | date: '%Y-%m-%d' }}">{{ latest_date_display }}</time>
                            {%- else -%}—{%- endif -%}
                        </div>
                        <div class="releases-table-content-item">—</div>
                        <div class="releases-table-content-item">—</div>
                        <div class="releases-table-content-item">
                            <a href="{{ notes_url }}">{{ family_label }}</a>
                        </div>
                        <div class="releases-table-content-item">
                            <a href="/docs/user-guide/install/pe/upgrade-instructions/?version={{ family_label }}">Upgrade</a>
                        </div>
                    </div>
                </div>
            {%- endfor -%}
        </div>
    </div>
</div>
