{% capture plans %}{% include private-cloud-plans.json %}{% endcapture %}

<div id="calculatorModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-body">
            <div id="closeBtn" class="close-button">
                <img src="https://img.thingsboard.io/pricing/close-icon.svg" alt="Close icon">
            </div>
            <div class="card calculator">
                <h2>Private Cloud Plan calculator</h2>
                <div class="input-parameters">
                    <div class="device-profiles-container">
                    </div>
                    <div class="input-group">
                        <div class="input-label-group">
                            <label for="retention" class="label">
                                Data Retention (Months)
                                <span class="tooltip"><img src="https://img.thingsboard.io/pricing/info-icon.svg" alt="Hint icon"><span class="tooltip-text">How long you need to store your data</span></span>
                            </label>
                            <input id="retention" type="number" value="12" max="1200" class="input input-right">
                        </div>
                        <div class="slider-container">
                            <label for="retentionSlider" class="visually-hidden">How long you need to store your data</label>
                            <input type="range" id="retentionSlider" min="1" max="60" step="1" value="12" class="slider">
                            <div class="tick-marks">
                                <div class="tick-mark" data-num="1"><span class="tick"></span><span class="tick-label">1</span></div>
                                <div class="tick-mark" data-num="12"><span class="tick"></span><span class="tick-label">12</span></div>
                                <div class="tick-mark" data-num="24"><span class="tick"></span><span class="tick-label">24</span></div>
                                <div class="tick-mark" data-num="36"><span class="tick"></span><span class="tick-label">36</span></div>
                                <div class="tick-mark" data-num="48"><span class="tick"></span><span class="tick-label">48</span></div>
                                <div class="tick-mark" data-num="60"><span class="tick"></span><span class="tick-label">60</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group addons">
                        <p class="label">Add-ons</p>
                        <div class="add-ons-container">
                            <label class="add-on">
                                <input class="add-on-checkbox" id="devEnvs" type="checkbox">
                                <span class="checkmark"></span>
                                Dev Environment
                            </label>
                            <label class="add-on">
                                <input class="add-on-checkbox" id="testEnvs" type="checkbox">
                                <span class="checkmark"></span>
                                Test Environment
                            </label>
                            <label class="add-on">
                                <input class="add-on-checkbox" id="mobileApp" type="checkbox">
                                <span class="checkmark"></span>
                                White-labeled Mobile App
                            </label>
                        </div>
                    </div>
                </div>
                <div class="actions-container">
                    <div class="mode-toggle-container">
                        <span class="label-text selected">Basic</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="advancedModeToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="label-text">
                        Advanced
                            <span class="tooltip"><img src="https://img.thingsboard.io/pricing/info-icon.svg" alt="Hint icon">
                                <span class="tooltip-text">Enable multiple device profiles</span>
                            </span>
                        </span>
                    </div>
                    <div class="reset-container">
                        <button id="calculatorReset" class="button reset">Reset</button>
                    </div>
                </div>
            </div>
            <div id="resultsCard" class="card results hidden"></div>
        </div>
    </div>
    <div id="payloadModal" class="payload-modal-overlay">
        <div class="modal-content">
            <div class="modal-wrapper">
                <div class="modal-header">
                    <h2>Upload sample to calculate data points</h2>
                    <div id="closePayloadModalBtn" class="close-button">
                        <img src="https://img.thingsboard.io/pricing/close-icon.svg" alt="Close icon">
                    </div>
                </div>
                <div class="input-group">
                    <label for="json-input">JSON value
                        <span class="tooltip"><img src="https://img.thingsboard.io/pricing/info-icon.svg" alt="Hint icon">
                            <span class="tooltip-text">For simplicity, this editor supports only JSON format. While ThingsBoard supports other payload formats in real-world use cases, this calculator is designed to keep things easy and straightforward.</span>
                        </span>
                    </label>
                    <textarea id="json-input" spellcheck="false"></textarea>
                    <p id="errorMessage"></p>
                </div>
                <div class="footer">
                    <div class="data-points">
                        Data points per message: <span id="dataPointCount">0</span>
                    </div>
                    <button class="button" id="applyPayloadBtn">Apply payload</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const privateCloudPlans = {{ plans }};

    let calculatorState = {
        clipboardMessage: '',
        optimalPlanName: '',
        price: 0,
        extraStoragePrice: 0,
        debounceTimer: null,
        isAdvancedMode: false,
        deviceProfiles: []
    };

    const elements = {
        openCalculatorBtn: document.getElementById('openCalculatorBtn'),
        modal: document.getElementById('calculatorModal'),
        closeBtn: document.getElementById('closeBtn'),
        resultsCard: document.getElementById('resultsCard'),
        resetButton: document.getElementById('calculatorReset'),
        deviceProfilesContainer: document.querySelector('.device-profiles-container'),

        retentionInput: document.getElementById('retention'),
        retentionSlider: document.getElementById('retentionSlider'),

        devEnvsCheckbox: document.getElementById('devEnvs'),
        testEnvsCheckbox: document.getElementById('testEnvs'),
        mobileAppCheckbox: document.getElementById('mobileApp'),

        openPayloadModalBtn: null,
        payloadModal: document.getElementById('payloadModal'),
        closePayloadModalBtn: document.getElementById('closePayloadModalBtn'),
        applyPayloadBtn: document.getElementById('applyPayloadBtn'),
        jsonInput: document.getElementById('json-input'),
        dataPointCountEl: document.getElementById('dataPointCount'),
        errorMessageEl: document.getElementById('errorMessage'),

        advancedModeToggle: document.getElementById('advancedModeToggle')
    };

    const icon = `<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M5.49976 3.5H4.49976V2.5H5.49976V3.5ZM5.49976 4.5H4.49976V7.5H5.49976V4.5ZM4.99976 1C2.79426 1 0.999756 2.7945 0.999756 5C0.999756 7.2055 2.79426 9 4.99976 9C7.20526 9 8.99976 7.2055 8.99976 5C8.99976 2.7945 7.20526 1 4.99976 1ZM4.99976 0C7.76126 0 9.99976 2.2385 9.99976 5C9.99976 7.7615 7.76126 10 4.99976 10C2.23826 10 -0.000244141 7.7615 -0.000244141 5C-0.000244141 2.2385 2.23826 0 4.99976 0Z" fill="black" fill-opacity="0.76"/></svg>`;

    const deviceProfileTemplate = `
    <div class="device-profile" data-profile-id="{PROFILE_ID}">
        <div class="wrapper">
            <h3>Device profile {PROFILE_NUMBER}</h3>
            <div class="remove-profile-btn hidden"><img src="https://img.thingsboard.io/pricing/close-icon.svg" alt="Close icon"></div>
            <div class="input-group">
                <div class="input-label-group">
                    <label for="devices-{PROFILE_ID}" class="label">
                        Devices
                        <span class="tooltip"><img src="https://img.thingsboard.io/pricing/info-icon.svg" alt="Hint icon" onerror="this.style.display='none'">
                            <span class="tooltip-text">The total number of IoT devices that will connect to ThingsBoard</span>
                        </span>
                    </label>
                    <input id="devices-{PROFILE_ID}" type="number" value="5000" class="input input-right" data-profile-input="devices">
                </div>
                <div class="slider-container">
                    <input type="range" id="devicesSlider-{PROFILE_ID}" min="0" max="120000" step="100" value="5000" class="slider" data-profile-slider="devices">
                    <div class="tick-marks">
                        <div class="tick-mark" data-num="1"><span class="tick"></span><span class="tick-label">1</span></div>
                        <div class="tick-mark" data-num="5000"><span class="tick"></span><span class="tick-label">5K</span></div>
                        <div class="tick-mark" data-num="25000"><span class="tick"></span><span class="tick-label">25K</span></div>
                        <div class="tick-mark" data-num="50000"><span class="tick"></span><span class="tick-label">50K</span></div>
                        <div class="tick-mark" data-num="100000"><span class="tick"></span><span class="tick-label">100K</span></div>
                        <div class="tick-mark" data-num="120000"><span class="tick"></span><span class="tick-label infinity">&#8734;</span></div>
                    </div>
                </div>
            </div>
            <div class="input-group">
                <div class="input-label-group">
                    <label for="messages-{PROFILE_ID}" class="label">
                        Messages per Device
                        <span class="tooltip"><img src="https://img.thingsboard.io/pricing/info-icon.svg" alt="Hint icon" onerror="this.style.display='none'">
                            <span class="tooltip-text">How many messages each device sends in the selected time period</span>
                        </span>
                    </label>
                    <div class="input-with-select">
                        <input id="messages-{PROFILE_ID}" type="number" value="1" class="input input-right" data-profile-input="messages">
                        <select id="messageUnit-{PROFILE_ID}" class="select" data-profile-select="messageUnit">
                            <option value="minute">per minute</option>
                            <option value="hour" selected>per hour</option>
                            <option value="day">per day</option>
                        </select>
                    </div>
                </div>
                <div class="slider-container messages">
                    <input type="range" id="messagesSlider-{PROFILE_ID}" min="1" max="60" step="1" value="1" class="slider" data-profile-slider="messages">
                    <div id="msgPerMinute-{PROFILE_ID}" class="tick-marks hidden">
                        <div class="tick-mark" data-num="1"><span class="tick"></span><span class="tick-label">1</span></div>
                        <div class="tick-mark" data-num="20"><span class="tick"></span><span class="tick-label">20</span></div>
                        <div class="tick-mark" data-num="40"><span class="tick"></span><span class="tick-label">40</span></div>
                        <div class="tick-mark" data-num="60"><span class="tick"></span><span class="tick-label">60</span></div>
                    </div>
                    <div id="msgPerHour-{PROFILE_ID}" class="tick-marks">
                        <div class="tick-mark" data-num="1"><span class="tick"></span><span class="tick-label">1</span></div>
                        <div class="tick-mark" data-num="20"><span class="tick"></span><span class="tick-label">20</span></div>
                        <div class="tick-mark" data-num="40"><span class="tick"></span><span class="tick-label">40</span></div>
                        <div class="tick-mark" data-num="60"><span class="tick"></span><span class="tick-label">60</span></div>
                    </div>
                    <div id="msgPerDay-{PROFILE_ID}" class="tick-marks hidden">
                        <div class="tick-mark" data-num="1"><span class="tick"></span><span class="tick-label">1</span></div>
                        <div class="tick-mark" data-num="8"><span class="tick"></span><span class="tick-label">8</span></div>
                        <div class="tick-mark" data-num="16"><span class="tick"></span><span class="tick-label">16</span></div>
                        <div class="tick-mark" data-num="24"><span class="tick"></span><span class="tick-label">24</span></div>
                    </div>
                </div>
            </div>
            <div class="input-group">
                <div class="input-label-group">
                    <label for="dataPoints-{PROFILE_ID}" class="label">
                        Data Points per Message
                        <span class="tooltip"><img src="https://img.thingsboard.io/pricing/info-icon.svg" alt="Hint icon" onerror="this.style.display='none'"><span class="tooltip-text">How many data points are included in each message</span></span>
                    </label>
                    <button class="payload" data-profile-payload-btn="{PROFILE_ID}">Submit payload</button>
                    <input id="dataPoints-{PROFILE_ID}" type="number" value="3" class="input input-right" data-profile-input="dataPoints">
                </div>
                <div class="slider-container">
                    <input type="range" id="dataPointsSlider-{PROFILE_ID}" min="1" max="100" step="1" value="3" class="slider" data-profile-slider="dataPoints">
                    <div class="tick-marks">
                        <div class="tick-mark" data-num="1"><span class="tick"></span><span class="tick-label">1</span></div>
                        <div class="tick-mark" data-num="20"><span class="tick"></span><span class="tick-label">20</span></div>
                        <div class="tick-mark" data-num="40"><span class="tick"></span><span class="tick-label">40</span></div>
                        <div class="tick-mark" data-num="60"><span class="tick"></span><span class="tick-label">60</span></div>
                        <div class="tick-mark" data-num="80"><span class="tick"></span><span class="tick-label">80</span></div>
                        <div class="tick-mark" data-num="100"><span class="tick"></span><span class="tick-label">100</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="add-profile-btn-container">
            <div class="add-profile-btn">
                <hr>
                <img src="https://img.thingsboard.io/pricing/pricing-plus-icon.svg" alt="Plus icon">
                <span>Add device profile</span>
                <hr>
            </div>
        </div>
    </div>
`;

    const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(value).replace(/,/g, ' ');
    const formatNumber = (value, fractionDigits = 2) => new Intl.NumberFormat('en-US', { style: 'decimal', maximumFractionDigits: fractionDigits }).format(value).replace(/,/g, ' ');

    const sliderProgress = (slider) => {
        const progress = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.background = `linear-gradient(to right, #2A7DEC ${progress}%, #E0E1E2 ${progress}%)`;
    };

    const copyToClipboard = (button) => {
        const textArea = document.createElement("textarea");
        textArea.value = calculatorState.clipboardMessage;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);

        button.classList.add('copied');
        const tooltipEl = button.querySelector('.tooltip-text');
        const originalText = tooltipEl.innerHTML;
        tooltipEl.innerHTML = "Copied!";
        setTimeout(() => {
            tooltipEl.innerHTML = originalText;
            button.classList.remove('copied');
        }, 1500);
    };

    const openModal = (modalElement) => {
        modalElement.classList.add('visible');
        document.body.style.overflow = 'hidden';
    };
    const closeModal = (modalElement) => {
        modalElement.classList.remove('visible');
        if (!document.querySelector('.modal-overlay.visible')) {
            document.body.style.overflow = 'auto';
        }
    };

    function initTickMarks() {
        document.querySelectorAll('.slider-container').forEach(sliderContainer => {
            const sliderInput = sliderContainer.querySelector('input.slider');
            const min = parseInt(sliderInput.min, 10);
            const max = parseInt(sliderInput.max, 10);
            const range = max - min;
            const sliderPhysicalWidth = sliderInput.offsetWidth;
            const thumbPhysicalWidth = 25;

            let trackRatio = 0;
            if (sliderPhysicalWidth > 0) {
                trackRatio = thumbPhysicalWidth / sliderPhysicalWidth;
            }

            const tickMarks = sliderContainer.querySelectorAll('.tick-marks .tick-mark');

            tickMarks.forEach((tickMark) => {
                let tickValueText = tickMark.dataset.num;
                const tickValue = parseInt(tickValueText, 10);
                const relativeValue = (tickValue - min) / range;
                const percentPosition = ((trackRatio / 2) + (relativeValue * (1 - trackRatio))) * 100;

                tickMark.style.left = percentPosition + '%';
            });
        });
    }

    const initCardResize = () => {
        const card = document.querySelector('.card.calculator');
        const fixedElement = document.querySelector('.actions-container');

        const observer = new ResizeObserver(entries => {
            for (let entry of entries) {
                const contentWidth = entry.target.clientWidth;

                fixedElement.style.width = `${contentWidth - 96}px`;
            }
        });

        observer.observe(card);
    }

    const updateMessageSliderTicks = (profileId) => {
        const profileElement = elements.deviceProfilesContainer.querySelector(`[data-profile-id="${profileId}"]`);
        if (!profileElement) return;

        const msgSelect = profileElement.querySelector(`[data-profile-select="messageUnit"]`);
        const msgSlider = profileElement.querySelector(`[data-profile-slider="messages"]`);

        ['msgPerMinute', 'msgPerHour', 'msgPerDay'].forEach(idSuffix => {
            const el = profileElement.querySelector(`#${idSuffix}-${profileId}`);
            if (el) el.classList.add('hidden');
        });

        if (msgSelect.value === 'minute') {
            msgSlider.max = 60;
            const targetEl = profileElement.querySelector(`#msgPerMinute-${profileId}`);
            if (targetEl) targetEl.classList.remove('hidden');
        } else if (msgSelect.value === 'hour') {
            msgSlider.max = 60;
            const targetEl = profileElement.querySelector(`#msgPerHour-${profileId}`);
            if (targetEl) targetEl.classList.remove('hidden');
        } else if (msgSelect.value === 'day') {
            msgSlider.max = 24;
            msgSlider.value = 1;
            const messagesInput = profileElement.querySelector(`[data-profile-input="messages"]`);
            if (messagesInput) messagesInput.value = 1;
            const targetEl = profileElement.querySelector(`#msgPerDay-${profileId}`);
            if (targetEl) targetEl.classList.remove('hidden');
        }
        sliderProgress(msgSlider);
        initTickMarks(profileElement);
    };

    let nextProfileId = 1;

    const updateUIAfterProfileChange = () => {
        const allProfiles = elements.deviceProfilesContainer.querySelectorAll('.device-profile');

        allProfiles.forEach((el, index) => {
            const h3 = el.querySelector('h3');
            if (h3) {
                h3.textContent = `Device profile ${index + 1}`;
            }

            const removeBtn = el.querySelector('.remove-profile-btn');
            if (removeBtn) {
                 if (calculatorState.deviceProfiles.length > 1 && calculatorState.isAdvancedMode) {
                    removeBtn.classList.remove('hidden');
                } else {
                    removeBtn.classList.add('hidden');
                }
            }
        });

        calculateResults();
    }

    const addDeviceProfile = (options = {}, init) => {
        const {
            initialValues = { devices: 5000, messages: 1, messageUnit: 'hour', dataPoints: 3 },
            insertAfterId = null
        } = options;

        const profileId = nextProfileId++;

        const profileData = {
            id: profileId,
            devices: initialValues.devices,
            messages: initialValues.messages,
            messageUnit: initialValues.messageUnit,
            dataPoints: initialValues.dataPoints
        };

        let profileHtml = deviceProfileTemplate
            .replace(/{PROFILE_ID}/g, profileId)
            .replace(/{PROFILE_NUMBER}/g, 0);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = profileHtml.trim();
        const profileElement = tempDiv.firstChild;

        profileElement.querySelector(`[data-profile-input="devices"]`).value = profileData.devices;
        profileElement.querySelector(`[data-profile-slider="devices"]`).value = profileData.devices;
        profileElement.querySelector(`[data-profile-input="messages"]`).value = profileData.messages;
        profileElement.querySelector(`[data-profile-slider="messages"]`).value = profileData.messages;
        profileElement.querySelector(`[data-profile-select="messageUnit"]`).value = profileData.messageUnit;
        profileElement.querySelector(`[data-profile-input="dataPoints"]`).value = profileData.dataPoints;
        profileElement.querySelector(`[data-profile-slider="dataPoints"]`).value = profileData.dataPoints;

        const insertionIndex = (insertAfterId === null) ?
            calculatorState.deviceProfiles.length :
            calculatorState.deviceProfiles.findIndex(p => p.id === insertAfterId) + 1;

        calculatorState.deviceProfiles.splice(insertionIndex, 0, profileData);

        const referenceNode = (insertAfterId === null) ?
            null :
            elements.deviceProfilesContainer.querySelector(`[data-profile-id="${insertAfterId}"]`);

        if (referenceNode) {
            referenceNode.after(profileElement);
        } else {
            elements.deviceProfilesContainer.appendChild(profileElement);
        }

        if(calculatorState.isAdvancedMode) {
            elements.deviceProfilesContainer.classList.add('advanced');
        }

        profileElement.querySelectorAll('.slider').forEach(sliderProgress);
        updateMessageSliderTicks(profileId);
        updateUIAfterProfileChange();
        if (!init) {
            debouncedSendToGTM();
        }
    };

    const removeDeviceProfile = (profileId) => {
        const profileIndex = calculatorState.deviceProfiles.findIndex(p => p.id === profileId);
        if (profileIndex === -1) return;
        calculatorState.deviceProfiles.splice(profileIndex, 1);

        const profileElement = elements.deviceProfilesContainer.querySelector(`[data-profile-id="${profileId}"]`);
        if (profileElement) {
            profileElement.remove();
        }

        updateUIAfterProfileChange();
        debouncedSendToGTM();
    };

    const getCalculatorInputs = () => {
        const retention = Number(elements.retentionInput.value) || 0;
        const devEnvs = elements.devEnvsCheckbox.checked;
        const testEnvs = elements.testEnvsCheckbox.checked;
        const mobileApp = elements.mobileAppCheckbox.checked;

        let totalDataPointsPerMinute = 0;
        let totalDevices = 0;
        let totalMessages = 0;
        const profilesData = calculatorState.deviceProfiles.map(profile => {
            let messagesPerMinute = profile.messages;
            if (profile.messageUnit === 'hour') messagesPerMinute /= 60;
            else if (profile.messageUnit === 'day') messagesPerMinute /= (24 * 60);

            const profileDataPointsPerMinute = profile.devices * messagesPerMinute * profile.dataPoints;
            totalDataPointsPerMinute += profileDataPointsPerMinute;
            totalDevices += profile.devices;
            totalMessages += profile.messages;
            return { ...profile, messagesPerMinute, dataPointsPerMinute: profileDataPointsPerMinute };
        });

        return {
            deviceProfiles: profilesData,
            retention,
            devEnvs,
            testEnvs,
            mobileApp,
            totalDataPointsPerMinute,
            totalDevices
        };
    };

    const calculateResults = () => {
        const inputs = getCalculatorInputs();
        const dataRetention = inputs.retention;
        const retentionInMinutes = dataRetention * 30 * 24 * 60;

        const matchingPlans = privateCloudPlans.plans.filter(plan => inputs.totalDataPointsPerMinute <= plan.maxMsgPerMin);

        if (matchingPlans.length === 0) {
            displayEnterpriseResults(inputs, inputs.totalDataPointsPerMinute, retentionInMinutes);
            return;
        }

        const planResults = matchingPlans.map(plan => {
            const extraDevices = Math.max(0, inputs.deviceProfiles.reduce((sum, p) => sum + p.devices, 0) - plan.includedDevices);
            const extraDeviceCost = extraDevices * plan.extraDevicePrice;

            const storageNeededInGB = (plan.bytesPerDataPoint * retentionInMinutes * inputs.totalDataPointsPerMinute) / 1073741824;
            const adjustedStorageNeeded = storageNeededInGB * plan.replicationFactor;
            const extraStorage = Math.max(0, adjustedStorageNeeded - plan.storage);
            const extraStorageCost = extraStorage * privateCloudPlans.extraStorageCostPerGB;

            const basePrice = plan.price + extraDeviceCost + extraStorageCost;

            let addOnsCost = 0;
            if (inputs.devEnvs) addOnsCost += privateCloudPlans.devEnvironments;
            if (inputs.testEnvs) addOnsCost += privateCloudPlans.testEnvironments;
            if (inputs.mobileApp) addOnsCost += privateCloudPlans.mobileApp;

            return {
                plan, extraDevices, extraDeviceCost, storageNeeded: adjustedStorageNeeded,
                extraStorage, extraStorageCost, basePrice, addOnsCost,
                totalPrice: basePrice + addOnsCost, dataPointsPerMinute: inputs.totalDataPointsPerMinute, retentionInMinutes
            };
        });

        const optimalPlan = planResults.reduce((prev, current) => (prev.totalPrice < current.totalPrice ? prev : current));
        if (optimalPlan.totalPrice > 10000) {
            displayEnterpriseResults(inputs, inputs.totalDataPointsPerMinute, retentionInMinutes);
            return;
        }
        displayResults(optimalPlan, inputs);
    };

    const displayResults = (results, inputs) => {
        const { plan, extraDevices, extraDeviceCost, storageNeeded, extraStorage, extraStorageCost, totalPrice, dataPointsPerMinute, retentionInMinutes } = results;

        calculatorState.optimalPlanName = plan.name;
        calculatorState.price = totalPrice;
        calculatorState.extraStoragePrice = extraStorageCost;

        const addonsHtml = generateAddonsHtml(inputs);
        const totalPriceTooltip = `The total amount you'll pay each month based on your usage. <br> ${formatCurrency(totalPrice)} = ${formatCurrency(plan.price)} (base plan) + ${formatCurrency(extraDeviceCost)} (extra devices) + ${formatCurrency(extraStorageCost)} (extra storage)` +
            (inputs.devEnvs ? ` + ${formatCurrency(privateCloudPlans.devEnvironments)} (dev environment)` : '') +
            (inputs.testEnvs ? ` + ${formatCurrency(privateCloudPlans.testEnvironments)} (test environment)` : '') +
            (inputs.mobileApp ? ` + ${formatCurrency(privateCloudPlans.mobileApp)} (mobile app monthly)` : '');

        elements.resultsCard.classList.remove('hidden');
        elements.resultsCard.innerHTML = `
            <div class="card-header">
              <h3>
                Calculation summary
                <div id="copyButton" class="copy-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 4V16C8 16.5304 8.21071 17.0391 8.58579 17.4142C8.96086 17.7893 9.46957 18 10 18H18C18.5304 18 19.0391 17.7893 19.4142 17.4142C19.7893 17.0391 20 16.5304 20 16V7.242C20 6.97556 19.9467 6.71181 19.8433 6.46624C19.7399 6.22068 19.5885 5.99824 19.398 5.812L16.083 2.57C15.7094 2.20466 15.2076 2.00007 14.685 2H10C9.46957 2 8.96086 2.21071 8.58579 2.58579C8.21071 2.96086 8 3.46957 8 4Z" stroke="black" stroke-opacity="0.76" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 18V20C16 20.5304 15.7893 21.0391 15.4142 21.4142C15.0391 21.7893 14.5304 22 14 22H6C5.46957 22 4.96086 21.7893 4.58579 21.4142C4.21071 21.0391 4 20.5304 4 20V9C4 8.46957 4.21071 7.96086 4.58579 7.58579C4.96086 7.21071 5.46957 7 6 7H8" stroke="black" stroke-opacity="0.76" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="tooltip-text">Copy calculation summary</span>
                </div>
              </h3>
              <h4>Optimal Plan: ${plan.name} (${formatCurrency(plan.price)})</h4>
            </div>
            <div class="results">
              ${createResultItem('Data Points Rate', `${formatNumber(dataPointsPerMinute)} points/min`, 'The rate at which your devices generate data points that need to be processed and stored.')}
              ${createResultItem('Included Devices', formatNumber(plan.includedDevices, 0), null, true)}
              ${createResultItem('Extra Devices', formatNumber(extraDevices, 0), 'The number of devices exceeding what\'s included in your base plan.')}
              ${createResultItem('Extra Device Cost', formatCurrency(extraDeviceCost), `The additional cost for devices beyond what\'s included in your base plan.<br>${formatCurrency(extraDeviceCost)} = ${formatNumber(extraDevices, 0)} extra devices × $${plan.extraDevicePrice}/device`)}
              ${createResultItem('Included Storage', `${formatNumber(plan.storage, 0)} GB`, `The amount of storage included in your base plan price.<br>The ${plan.name} plan includes ${formatNumber(plan.storage, 0)} GB of storage.`)}
              ${createResultItem('Time-Series Database', plan.database, 'The Launch plan uses SQL Database (PostgreSQL) with a replication factor of 2, ideal for lightweight deployments. Growth, Scale, and Enterprise plans use NoSQL (Cassandra) with a replication factor of 3 to store time-series data. Cassandra storage is more efficient—each data point occupies on average five times less space before replication. For workloads with large storage requirements, NoSQL-based plans are more cost-efficient thanks to their reduced storage footprint.')}
              ${createResultItem('Storage Used', `${formatNumber(storageNeeded)} GB`, `Number of data points in storage:<br>${formatNumber(dataPointsPerMinute, 2)}&nbsp;points/minute × 60&nbsp;minutes in hour × 24&nbsp;hours in day × 30&nbsp;days in month × ${elements.retentionInput.value}&nbsp;months = ${formatNumber(retentionInMinutes * dataPointsPerMinute, 0)}&nbsp;data points;<br><br>Storage required:<br>${formatNumber(retentionInMinutes * dataPointsPerMinute, 0)} × ${plan.bytesPerDataPoint}(approximate size of data point in DB) × ${plan.replicationFactor}(replication factor) / bytes in GB = ${formatNumber(storageNeeded, 2)}&nbsp;GB`)}
              ${createResultItem('Extra Storage', `${formatNumber(extraStorage, 2)} GB`, `The amount of storage exceeding what's included in your base plan. <br>${formatNumber(extraStorage, 2)} GB = ${formatNumber(storageNeeded, 2)} GB used - ${formatNumber(plan.storage, 0)} GB included`)}
              ${createResultItem('Extra Storage Cost', formatCurrency(extraStorageCost), `The additional cost for storage beyond what's included in your base plan. <br>${formatCurrency(extraStorageCost)} = ${formatNumber(extraStorage, 2)} GB × $${privateCloudPlans.extraStorageCostPerGB}/GB`)}
            </div>
            ${addonsHtml}
            <div class="results-total">
              <span>Total monthly price:</span>
              <span>${formatCurrency(totalPrice)}<span class="tooltip">${icon}<span class="tooltip-text">${totalPriceTooltip}</span></span></span>
            </div>
            <a id="contactUs" class="button" href="/docs/contact-us/">Contact Us</a>`;

        updateContactAndClipboard(results, inputs);
        document.getElementById('copyButton').addEventListener('click', (e) => copyToClipboard(e.currentTarget));
    };

    const displayEnterpriseResults = (inputs, totalDataPointsPerMinute, retentionInMinutes) => {
        const totalDevices = inputs.deviceProfiles.reduce((sum, p) => sum + p.devices, 0);
        const storageNeededInGB = (privateCloudPlans.enterpriseBytesPerDataPoint * retentionInMinutes * totalDataPointsPerMinute) / 1073741824;
        calculatorState.optimalPlanName = 'Enterprise';
        calculatorState.price = 0;
        calculatorState.extraStoragePrice = 0;

        elements.resultsCard.classList.remove('hidden');
        elements.resultsCard.innerHTML = `
            <div class="card-header">
              <h3>
                Calculation summary
                <div id="copyButton" class="copy-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 4V16C8 16.5304 8.21071 17.0391 8.58579 17.4142C8.96086 17.7893 9.46957 18 10 18H18C18.5304 18 19.0391 17.7893 19.4142 17.4142C19.7893 17.0391 20 16.5304 20 16V7.242C20 6.97556 19.9467 6.71181 19.8433 6.46624C19.7399 6.22068 19.5885 5.99824 19.398 5.812L16.083 2.57C15.7094 2.20466 15.2076 2.00007 14.685 2H10C9.46957 2 8.96086 2.21071 8.58579 2.58579C8.21071 2.96086 8 3.46957 8 4Z" stroke="black" stroke-opacity="0.76" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 18V20C16 20.5304 15.7893 21.0391 15.4142 21.4142C15.0391 21.7893 14.5304 22 14 22H6C5.46957 22 4.96086 21.7893 4.58579 21.4142C4.21071 21.0391 4 20.5304 4 20V9C4 8.46957 4.21071 7.96086 4.58579 7.58579C4.96086 7.21071 5.46957 7 6 7H8" stroke="black" stroke-opacity="0.76" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="tooltip-text">Copy calculation summary</span>
                </div>
              </h3>
              <h4 class="wrap">Your setup is seriously impressive. It's time for an Enterprise solution!</h4>
            </div>
            <div class="results">
              ${createResultItem('Data Points Rate', `${formatNumber(totalDataPointsPerMinute)} points/minute`)}
              ${createResultItem('Estimated storage needed', `${formatNumber(storageNeededInGB)} GB`)}
            </div>
            <p class="contact-us-text">Please contact our sales team for a custom Enterprise solution.</p>
            <a id="contactUs" class="button" href="/docs/contact-us/">Contact Us</a>`;

        updateContactAndClipboard({ isEnterprise: true, totalDataPointsPerMinute, totalDevices, storageNeededInGB }, inputs);
        document.getElementById('copyButton').addEventListener('click', (e) => copyToClipboard(e.currentTarget));
    };

    const createResultItem = (label, value, tooltip = null, noTooltipIcon = false) => {
        const tooltipHtml = tooltip ? `<span class="tooltip">${icon}<span class="tooltip-text">${tooltip}</span></span>` : '';
        return `
            <div class="results-item">
              <span class="results-label">${label}:</span>
              <span class="results-value ${noTooltipIcon && !tooltip ? 'no-tooltip' : ''}">${value} ${tooltipHtml}</span>
            </div>`;
    };

    const generateAddonsHtml = (inputs) => {
        if (!inputs.devEnvs && !inputs.testEnvs && !inputs.mobileApp) return '';
        let block = '<div class="addons-results"><p>Add-ons</p>';
        if (inputs.devEnvs) block += createResultItem('Dev Environment', formatCurrency(privateCloudPlans.devEnvironments), null, true);
        if (inputs.testEnvs) block += createResultItem('Test Environment', formatCurrency(privateCloudPlans.testEnvironments), null, true);
        if (inputs.mobileApp) block += createResultItem('White-labeled Mobile App', formatCurrency(privateCloudPlans.mobileApp), `White-labeled Mobile App monthly price: ${formatCurrency(privateCloudPlans.mobileApp)}. <br> One-time setup fee: ${formatCurrency(privateCloudPlans.mobileAppSetup)}.`);
        block += '</div>';
        return block;
    };

    const updateContactAndClipboard = (results, inputs) => {
        let message;
        if (results.isEnterprise) {
            message = `Optimal Plan: Enterprise\n- Data Points Rate: ${formatNumber(results.totalDataPointsPerMinute, 2)} points/min\n- Total Devices: ${formatNumber(results.totalDevices, 0)}\n- Estimated Storage: ${formatNumber(results.storageNeededInGB, 2)} GB`;
        } else {
            const { plan, extraDevices, extraDeviceCost, storageNeeded, extraStorage, extraStorageCost, totalPrice } = results;
            const totalDevices = inputs.deviceProfiles.reduce((sum, p) => sum + p.devices, 0);

            message = `Optimal Plan: ${plan.name} (${formatCurrency(plan.price)})\n` +
                `- Data Points Rate: ${formatNumber(results.dataPointsPerMinute, 2)} points/min\n` +
                `- Included Devices: ${formatNumber(plan.includedDevices, 0)}\n` +
                `- Total Devices: ${formatNumber(totalDevices, 0)}\n` +
                `- Extra Devices: ${formatNumber(extraDevices, 0)}\n` +
                `- Extra Device Cost: ${formatCurrency(extraDeviceCost)}\n` +
                `- Included Storage: ${formatNumber(plan.storage, 0)} GB\n` +
                `- Storage Used: ${formatNumber(storageNeeded, 2)} GB\n` +
                `- Extra Storage: ${formatNumber(extraStorage, 2)} GB\n` +
                `- Extra Storage Cost: ${formatCurrency(extraStorageCost)}\n` +
                (inputs.devEnvs || inputs.testEnvs || inputs.mobileApp ? 'Add-ons:\n' : '') +
                (inputs.devEnvs ? `- Dev Environment: ${formatCurrency(privateCloudPlans.devEnvironments)}\n` : '') +
                (inputs.testEnvs ? `- Test Environment: ${formatCurrency(privateCloudPlans.testEnvironments)}\n` : '') +
                (inputs.mobileApp ? `- Mobile App: ${formatCurrency(privateCloudPlans.mobileApp)} (monthly) + ${formatCurrency(privateCloudPlans.mobileAppSetup)} (setup)\n` : '') +
                `Total Monthly Cost: ${formatCurrency(totalPrice)}`;
        }

        message += `\n\nCalculator Input:\n` +
            `Data Retention: ${formatNumber(inputs.retention, 0)} months`;

        inputs.deviceProfiles.forEach((p, index) => {
            message += `\nProfile ${index + 1}:`;
            message += `\n - Devices: ${formatNumber(p.devices, 0)}`;
            message += `\n - Messages: ${formatNumber(p.messages, 0)} per ${p.messageUnit}`;
            message += `\n - Data Points: ${formatNumber(p.dataPoints, 0)}`;
        });

        calculatorState.clipboardMessage = message;
        const contactButton = document.getElementById('contactUs');
        if (contactButton) {
            contactButton.href = `/docs/contact-us/?subject=${encodeURIComponent('Private Cloud Plan')}&message=${encodeURIComponent(message)}`;
        }
    };

    const handleReset = () => {
        calculatorState.deviceProfiles = [];
        elements.deviceProfilesContainer.innerHTML = '';
        addDeviceProfile();

        elements.retentionInput.value = 12;
        elements.retentionSlider.value = 12;
        sliderProgress(elements.retentionSlider);

        elements.devEnvsCheckbox.checked = false;
        elements.testEnvsCheckbox.checked = false;
        elements.mobileAppCheckbox.checked = false;

        calculateResults();
        debouncedSendToGTM();
    };

    const handlePayloadModal = (profileId) => {
        elements.applyPayloadBtn.dataset.profileId = profileId;
        const jsonString = elements.jsonInput.value;
        elements.errorMessageEl.textContent = '';
        elements.jsonInput.classList.remove('error');

        if (jsonString.trim() === '') {
            elements.jsonInput.placeholder = '{\n  "temperature": 42.2,\n  "humidity": 70,\n  "hvacEnabled": true,\n  "hvacState": "IDLE",\n  "configuration": {\n    "someNumber": 42,\n    "someArray": [1, 2, 3],\n    "someNestedObject": { "key": "value" }\n    }\n}';
            elements.dataPointCountEl.textContent = '0';
            elements.dataPointCountEl.parentElement.classList.remove('visible');
            return;
        }

        try {
            const parsedJson = JSON.parse(jsonString);
            if (typeof parsedJson !== 'object' || parsedJson === null || Array.isArray(parsedJson)) {
                throw new Error();
            }
            elements.dataPointCountEl.textContent = Object.keys(parsedJson).length;
            elements.dataPointCountEl.parentElement.classList.add('visible');
            elements.errorMessageEl.textContent = '';
        } catch (error) {
            elements.dataPointCountEl.textContent = '0';
            elements.dataPointCountEl.parentElement.classList.remove('visible');
            elements.errorMessageEl.textContent = 'Please enter a valid JSON value.';
            elements.jsonInput.classList.add('error');
        }
    };

    const handleApplyPayload = () => {
        const profileId = elements.applyPayloadBtn.dataset.profileId;
        const dataPointsValue = elements.dataPointCountEl.textContent;
        const profileData = calculatorState.deviceProfiles.find(p => p.id == profileId);

        if (profileData && dataPointsValue && !elements.errorMessageEl.textContent) {
            profileData.dataPoints = Number(dataPointsValue);

            const profileElement = elements.deviceProfilesContainer.querySelector(`[data-profile-id="${profileId}"]`);
            if (profileElement) {
                const dataPointsInput = profileElement.querySelector(`[data-profile-input="dataPoints"]`);
                const dataPointsSlider = profileElement.querySelector(`[data-profile-slider="dataPoints"]`);
                if (dataPointsInput) dataPointsInput.value = dataPointsValue;
                if (dataPointsSlider) {
                    dataPointsSlider.value = dataPointsValue;
                    sliderProgress(dataPointsSlider);
                }
            }

            calculateResults();
            closeModal(elements.payloadModal);
            debouncedSendToGTM();
        }
    };

    const handleProfileInputChange = (event) => {
        const input = event.target;
        const profileElement = input.closest('.device-profile');
        if (!profileElement) return;

        const profileId = parseInt(profileElement.dataset.profileId, 10);
        const profileData = calculatorState.deviceProfiles.find(p => p.id === profileId);
        if (!profileData) return;

        if (input.dataset.profileInput) {
            profileData[input.dataset.profileInput] = Number(input.value) || 0;
            const slider = profileElement.querySelector(`[data-profile-slider="${input.dataset.profileInput}"]`);
            if (slider) {
                slider.value = input.value;
                sliderProgress(slider);
            }
        } else if (input.dataset.profileSelect === 'messageUnit') {
            profileData.messageUnit = input.value;
            updateMessageSliderTicks(profileId);
        }

        calculateResults();
        debouncedSendToGTM();
    };

    const handleProfileSliderChange = (event) => {
        const slider = event.target;
        const profileElement = slider.closest('.device-profile');
        if (!profileElement) return;

        const profileId = parseInt(profileElement.dataset.profileId, 10);
        const profileData = calculatorState.deviceProfiles.find(p => p.id === profileId);
        if (!profileData) return;

        if (slider.dataset.profileSlider) {
            profileData[slider.dataset.profileSlider] = Number(slider.value) || 0;
            const input = profileElement.querySelector(`[data-profile-input="${slider.dataset.profileSlider}"]`);
            if (input) {
                input.value = slider.value;
            }
        }

        sliderProgress(slider);
        calculateResults();
        debouncedSendToGTM();
    };

    const handleGlobalSliderChange = (event) => {
        const slider = event.target;
        const inputId = slider.id.replace('Slider', '');
        const input = document.getElementById(inputId);
        if (input) {
            input.value = slider.value;
        }
        sliderProgress(slider);
        calculateResults();
        debouncedSendToGTM();
    };

    const handleGlobalInputChange = (event) => {
        const input = event.target;
        if (input.id === 'retention' && input.value > 1200) {
            input.value = 1200;
        }
        const sliderId = input.id + 'Slider';
        const slider = document.getElementById(sliderId);
        if (slider) {
            slider.value = input.value;
            sliderProgress(slider);
        }
        calculateResults();
        debouncedSendToGTM();
    };

    const toggleAdvancedMode = (enableAdvanced, resetValues = true, init = false) => {
        calculatorState.isAdvancedMode = enableAdvanced;

        const labels = document.querySelectorAll(`.actions-container .label-text`);
        labels[0].classList.toggle('selected', !enableAdvanced);
        labels[1].classList.toggle('selected', enableAdvanced);

        if (enableAdvanced) {
            elements.deviceProfilesContainer.classList.add('advanced');
             if (calculatorState.deviceProfiles.length > 1) {
                elements.deviceProfilesContainer.querySelectorAll('.remove-profile-btn').forEach(btn => btn.classList.remove('hidden'));
             }
        } else {
            if (resetValues && calculatorState.deviceProfiles.length > 1) {
                const firstProfileData = { ...calculatorState.deviceProfiles[0]
                };
                elements.deviceProfilesContainer.innerHTML = '';
                calculatorState.deviceProfiles = [];
                addDeviceProfile({initialValues: firstProfileData});
            }
            elements.deviceProfilesContainer.classList.remove('advanced');
            elements.deviceProfilesContainer.querySelectorAll('.remove-profile-btn').forEach(btn => btn.classList.add('hidden'));
        }
        updateUIAfterProfileChange();
        if (!init) {
            debouncedSendToGTM();
        }
    };

    const debouncedSendToGTM = () => {
        clearTimeout(calculatorState.debounceTimer);
        calculatorState.debounceTimer = setTimeout(sendDataToGTM, 3000);
    };

    const sendDataToGTM = () => {
        if (typeof window.dataLayer === 'undefined') return;
        const inputs = getCalculatorInputs();
        const gtmData = {'event': 'calculator_interaction',
            'calculator_devices': inputs.totalDevices,
            'calculator_retention_months': inputs.retention,
            'calculator_addon_dev_envs': inputs.devEnvs,
            'calculator_addon_test_envs': inputs.testEnvs,
            'calculator_addon_mobile_app': inputs.mobileApp,
            'calculator_plan': calculatorState.optimalPlanName,
            'calculator_extra_storage_cost': calculatorState.extraStoragePrice,
            'calculator_price': calculatorState.price,
        };
        for (let i = 0; i <= 9; i++) {
            gtmData[`calculator_profile_${i}_json`] = null;
        }

        inputs.deviceProfiles.forEach((profile, index) => {
            gtmData[`calculator_profile_${index}_json`] = JSON.stringify({
                devices: parseInt(profile.devices) || 0,
                msgs: parseInt(profile.messages) || 0,
                unit: profile.messageUnit.charAt(0),
                points: parseInt(profile.dataPoints) || 0
            });
        });


        window.dataLayer.push(gtmData);
    };

    const init = () => {
        elements.openCalculatorBtn.addEventListener('click', () => {
            openModal(elements.modal);
            initTickMarks();
            toggleAdvancedMode(elements.advancedModeToggle.checked, false, true);
            calculateResults();
        });
        elements.closeBtn.addEventListener('click', () => closeModal(elements.modal));
        elements.modal.addEventListener('click', (event) => {
            if (event.target === elements.modal) closeModal(elements.modal);
        });
        elements.resetButton.addEventListener('click', handleReset);

        elements.retentionInput.addEventListener('input', handleGlobalInputChange);
        elements.retentionSlider.addEventListener('input', handleGlobalSliderChange);

        document.querySelectorAll('.add-on-checkbox').forEach(cb => {
            cb.addEventListener('change', () => {
                calculateResults();
                debouncedSendToGTM();
            });
        });

        elements.advancedModeToggle.addEventListener('change', (event) => {
            toggleAdvancedMode(event.target.checked);
        });

        elements.deviceProfilesContainer.addEventListener('input', (event) => {
            if (event.target.matches('[data-profile-input]')) {
                 handleProfileInputChange(event);
            } else if (event.target.matches('[data-profile-slider]')) {
                 handleProfileSliderChange(event);
            }
        });

        elements.deviceProfilesContainer.addEventListener('change', (event) => {
            if (event.target.matches('[data-profile-select]')) {
                handleProfileInputChange(event);
            }
        });

        elements.deviceProfilesContainer.addEventListener('click', (event) => {
            const removeBtn = event.target.closest('.remove-profile-btn');
            const payloadBtn = event.target.closest('[data-profile-payload-btn]');
            const addBtnContainer = event.target.closest('.add-profile-btn-container');

            if (removeBtn) {
                const profileElement = event.target.closest('.device-profile');
                if (profileElement) {
                    removeDeviceProfile(parseInt(profileElement.dataset.profileId, 10));
                }
            } else if (payloadBtn) {
                const profileId = payloadBtn.dataset.profilePayloadBtn;
                openModal(elements.payloadModal);
                handlePayloadModal(profileId);
            } else if (addBtnContainer) {
                 const profileElement = addBtnContainer.closest('.device-profile');
                 const profileId = profileElement ? parseInt(profileElement.dataset.profileId, 10) : null;
                 addDeviceProfile({ insertAfterId: profileId });
            }
        });

        elements.closePayloadModalBtn.addEventListener('click', () => closeModal(elements.payloadModal));
        elements.payloadModal.addEventListener('click', (e) => {
            if (e.target === elements.payloadModal) closeModal(elements.payloadModal);
        });
        elements.jsonInput.addEventListener('input', () => {
            const profileId = elements.applyPayloadBtn.dataset.profileId;
            if (profileId) handlePayloadModal(profileId);
        });
        elements.applyPayloadBtn.addEventListener('click', handleApplyPayload);

        sliderProgress(elements.retentionSlider);
        addDeviceProfile({}, true);
        toggleAdvancedMode(elements.advancedModeToggle.checked, false, true);
        initCardResize();
    };

    init();

</script>
