{%- assign dir = "/docs/" | append: docsPrefix | append: "releases/releases-table/" -%}
{%- assign base_install = "/docs/user-guide/install/" | append: docsPrefix | append: "upgrade-instructions/" -%}
{%- assign os_list = "ubuntu,centos,windows" | split: "," -%}

{%- assign pages_in_dir = site.pages | where_exp: "p", "p.url contains dir" -%}
{%- assign pages_sorted = pages_in_dir | sort: "release-date" | reverse -%}

{%- assign pages_sorted = pages_in_dir | sort: "release-date" | reverse -%}

<div class="releases-table upgrade-instructions-table{% if docsPrefix == "pe/" %} pe-table{% endif %}">
    <div class="releases-table-content">
        <div class="releases-table-header">
            <div class="releases-table-header-item">Version</div>
            <div class="releases-table-header-item">Release Date</div>
            <div class="releases-table-header-item">Upgradable From</div>
            <div class="releases-table-header-item">LTS</div>
            <div class="releases-table-header-item">Release Notes</div>
            <div class="releases-table-header-item">Upgrade Instructions</div>
        </div>

        <div class="releases-table-row">
            {%- for p in pages_sorted -%}
                {%- unless p.name == 'index.md' or p.name contains '.x.md' -%}
                    {%- assign version = p.name | replace: ".md", "" -%}
                    {%- assign family = version | split: "." | slice: 0, 2 | join: "." -%}
                    <div class="releases-table-content-wrapper" data-version="{{ version }}" data-family="{{ family }}">
                        <div class="releases-table-content">
                            <div class="releases-table-content-item">{{ version }}PE</div>
                            <div class="releases-table-content-item">{{ p["release-date"] | date: "%B %e, %Y" }}</div>
                            <div class="releases-table-content-item">{{ p["upgradable-from"] | default: "â€”" }}</div>

                            <div class="releases-table-content-item lts-item">
                                {%- if p.lts -%}
                                    <span class="lts-item-true">Available</span>
                                {%- else -%}
                                    <span>Not-available</span>
                                {%- endif -%}
                            </div>

                            <a href="/docs/{{ docsPrefix }}releases/releases-table/{{ version }}" class="releases-table-content-item version-link">
                                <span>{{ version }}</span>
                                <i class="fas fa-external-link-alt" style="opacity: 0.54; color: #000"></i>
                            </a>

                            <div class="releases-table-content-item upgrade-instructions">
                                {%- for os in os_list -%}
                                    {%- assign target = base_install | append: os | append: "/" | append: version -%}
                                    {%- assign target_slash = target | append: "/" -%}

                                    {%- assign page_noslash = site.pages | where: "url", target | first -%}
                                    {%- assign page_slash   = site.pages | where: "url", target_slash | first -%}

                                    {%- if page_noslash or page_slash -%}
                                        <a href="{{ target }}" data-tooltip="Upgrade {{ os | capitalize }} Instructions">
                                            <img src="/images/{{ os }}.svg" alt="Upgrade {{ os | capitalize }} Instructions">
                                        </a>
                                    {%- endif -%}
                                {%- endfor -%}

                                {%- assign docker_url = "/docs/user-guide/install/" | append: docsPrefix | append: "docker-windows/" -%}
                                {%- assign docker_page = site.pages | where: "url", docker_url | first -%}
                                {%- if docker_page -%}
                                    <a class="right-link" href="{{ docker_url }}" data-tooltip="Upgrade Docker Instructions">
                                        <img src="/images/docker.svg" alt="Upgrade Docker Instructions">
                                    </a>
                                {%- endif -%}
                            </div>
                        </div>
                    </div>
                {%- endunless -%}
            {%- endfor -%}
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const header = document.querySelector(".upgrade-instructions-table .releases-table-header");
        const tableRoot = document.querySelector(".upgrade-instructions-table");
        if (!header || !tableRoot) return;

        const placeholder = document.createElement("div");
        placeholder.className = "releases-table-header-placeholder";
        header.parentNode.insertBefore(placeholder, header.nextSibling);

        function getHeaderHeight() {
            return header.offsetHeight || 56;
        }

        function getFixThreshold() {
            const rect = header.getBoundingClientRect();
            return rect.top + window.scrollY - 140;
        }

        function syncGeometryToContainer() {
            const rect = tableRoot.getBoundingClientRect();
            header.style.left  = (rect.left + window.scrollX) + "px";
            header.style.width = rect.width + "px";
        }

        let headerHeight = getHeaderHeight();
        placeholder.style.setProperty("--header-height", headerHeight + "px");
        let threshold = getFixThreshold();

        function onScroll() {
            if (window.scrollY > threshold) {
                if (!header.classList.contains("fixed")) {
                    header.classList.add("fixed");
                    syncGeometryToContainer();
                    placeholder.style.height = headerHeight + "px";
                } else {
                    syncGeometryToContainer();
                }
            } else {
                if (header.classList.contains("fixed")) {
                    header.classList.remove("fixed");
                    header.style.left = "";
                    header.style.width = "";
                    placeholder.style.height = "0";
                }
            }
        }

        function onResize() {
            headerHeight = getHeaderHeight();
            placeholder.style.setProperty("--header-height", headerHeight + "px");
            threshold = getFixThreshold();
            if (header.classList.contains("fixed")) {
                syncGeometryToContainer();
                placeholder.style.height = headerHeight + "px";
            }
            onScroll();
        }

        window.addEventListener("scroll", onScroll, { passive: true });
        window.addEventListener("resize", onResize);

        onResize();
        onScroll();
    });
</script>
